
unvisited(0,0).
unvisited(0,2).
unvisited(0,4).
unvisited(0,6).
unvisited(0,8).
unvisited(0,10).
unvisited(0,12).
unvisited(0,14).                                                                                     
unvisited(0,16).                                                                                     
unvisited(0,18).                                                                                     
unvisited(0,20).                                                                                     
unvisited(0,22).                                                                                     
unvisited(0,24).                                                                                     
unvisited(0,26).                                                                                     
unvisited(0,28).                                                                                     
unvisited(0,30).                                                                                     
unvisited(0,32).                                                                                     
unvisited(0,34).                                                                                     
unvisited(2,0).                                                                                      
unvisited(2,2).                                                                                      
unvisited(2,4).
unvisited(2,6).
unvisited(2,8).
unvisited(2,10).
unvisited(2,12).
unvisited(2,14).
unvisited(2,16).
unvisited(2,18).
unvisited(2,20).
unvisited(2,22).
unvisited(2,24).
unvisited(2,26).
unvisited(2,28).
unvisited(2,30).
unvisited(2,32).
unvisited(2,34).
unvisited(4,0).
unvisited(4,2).
unvisited(4,4).
unvisited(4,6).
unvisited(4,8).
unvisited(4,10).
unvisited(4,12).
unvisited(4,14).
unvisited(4,16).
unvisited(4,18).
unvisited(4,20).
unvisited(4,22).
unvisited(4,24).
unvisited(4,26).
unvisited(4,28).
unvisited(4,30).
unvisited(4,32).
unvisited(4,34).
unvisited(6,0).
unvisited(6,2).
unvisited(6,4).
unvisited(6,6).
unvisited(6,8).
unvisited(6,10).
unvisited(6,12).
unvisited(6,14).
unvisited(6,16).
unvisited(6,18).
unvisited(6,20).
unvisited(6,22).
unvisited(6,24).
unvisited(6,26).
unvisited(6,28).
unvisited(6,30).
unvisited(6,32).
unvisited(6,34).
unvisited(8,0).
unvisited(8,2).
unvisited(8,4).
unvisited(8,6).
unvisited(8,8).
unvisited(8,10).
unvisited(8,12).
unvisited(8,14).
unvisited(8,16).
unvisited(8,18).
unvisited(8,20).
unvisited(8,22).
unvisited(8,24).
unvisited(8,26).
unvisited(8,28).
unvisited(8,30).
unvisited(8,32).
unvisited(8,34).
unvisited(10,0).
unvisited(10,2).
unvisited(10,4).
unvisited(10,6).
unvisited(10,8).
unvisited(10,10).
unvisited(10,12).
unvisited(10,14).
unvisited(10,16).
unvisited(10,18).
unvisited(10,20).
unvisited(10,22).
unvisited(10,24).
unvisited(10,26).
unvisited(10,28).
unvisited(10,30).
unvisited(10,32).
unvisited(10,34).
unvisited(12,0).
unvisited(12,2).
unvisited(12,4).
unvisited(12,6).
unvisited(12,8).
unvisited(12,10).
unvisited(12,12).
unvisited(12,14).
unvisited(12,16).
unvisited(12,18).
unvisited(12,20).
unvisited(12,22).
unvisited(12,24).
unvisited(12,26).
unvisited(12,28).
unvisited(12,30).
unvisited(12,32).
unvisited(12,34).
unvisited(14,0).
unvisited(14,2).
unvisited(14,4).
unvisited(14,6).
unvisited(14,8).
unvisited(14,10).
unvisited(14,12).
unvisited(14,14).
unvisited(14,16).
unvisited(14,18).
unvisited(14,20).
unvisited(14,22).
unvisited(14,24).
unvisited(14,26).
unvisited(14,28).
unvisited(14,30).
unvisited(14,32).
unvisited(14,34).
unvisited(16,0).
unvisited(16,2).
unvisited(16,4).
unvisited(16,6).
unvisited(16,8).
unvisited(16,10).
unvisited(16,12).
unvisited(16,14).
unvisited(16,16).
unvisited(16,18).
unvisited(16,20).
unvisited(16,22).
unvisited(16,24).
unvisited(16,26).
unvisited(16,28).
unvisited(16,30).
unvisited(16,32).
unvisited(16,34).
unvisited(18,0).
unvisited(18,2).
unvisited(18,4).
unvisited(18,6).
unvisited(18,8).
unvisited(18,10).
unvisited(18,12).
unvisited(18,14).
unvisited(18,16).
unvisited(18,18).
unvisited(18,20).
unvisited(18,22).
unvisited(18,24).
unvisited(18,26).
unvisited(18,28).
unvisited(18,30).
unvisited(18,32).
unvisited(18,34).
unvisited(20,0).
unvisited(20,2).
unvisited(20,4).
unvisited(20,6).
unvisited(20,8).
unvisited(20,10).
unvisited(20,12).
unvisited(20,14).
unvisited(20,16).
unvisited(20,18).
unvisited(20,20).
unvisited(20,22).
unvisited(20,24).
unvisited(20,26).
unvisited(20,28).
unvisited(20,30).
unvisited(20,32).
unvisited(20,34).
unvisited(22,0).
unvisited(22,2).
unvisited(22,4).
unvisited(22,6).
unvisited(22,8).
unvisited(22,10).
unvisited(22,12).
unvisited(22,14).
unvisited(22,16).
unvisited(22,18).
unvisited(22,20).
unvisited(22,22).
unvisited(22,24).
unvisited(22,26).
unvisited(22,28).
unvisited(22,30).
unvisited(22,32).
unvisited(22,34).
unvisited(24,0).
unvisited(24,2).
unvisited(24,4).
unvisited(24,6).
unvisited(24,8).
unvisited(24,10).
unvisited(24,12).
unvisited(24,14).
unvisited(24,16).
unvisited(24,18).
unvisited(24,20).
unvisited(24,22).
unvisited(24,24).
unvisited(24,26).
unvisited(24,28).
unvisited(24,30).
unvisited(24,32).
unvisited(24,34).
unvisited(26,0).
unvisited(26,2).
unvisited(26,4).
unvisited(26,6).
unvisited(26,8).
unvisited(26,10).
unvisited(26,12).
unvisited(26,14).
unvisited(26,16).
unvisited(26,18).
unvisited(26,20).
unvisited(26,22).
unvisited(26,24).
unvisited(26,26).
unvisited(26,28).
unvisited(26,30).
unvisited(26,32).
unvisited(26,34).
unvisited(28,0).
unvisited(28,2).
unvisited(28,4).
unvisited(28,6).
unvisited(28,8).
unvisited(28,10).
unvisited(28,12).
unvisited(28,14).
unvisited(28,16).
unvisited(28,18).
unvisited(28,20).
unvisited(28,22).
unvisited(28,24).
unvisited(28,26).
unvisited(28,28).
unvisited(28,30).
unvisited(28,32).
unvisited(28,34).
unvisited(30,0).
unvisited(30,2).
unvisited(30,4).
unvisited(30,6).
unvisited(30,8).
unvisited(30,10).
unvisited(30,12).
unvisited(30,14).
unvisited(30,16).
unvisited(30,18).
unvisited(30,20).
unvisited(30,22).
unvisited(30,24).
unvisited(30,26).
unvisited(30,28).
unvisited(30,30).
unvisited(30,32).
unvisited(30,34).
unvisited(32,0).
unvisited(32,2).
unvisited(32,4).
unvisited(32,6).
unvisited(32,8).
unvisited(32,10).
unvisited(32,12).
unvisited(32,14).
unvisited(32,16).
unvisited(32,18).
unvisited(32,20).
unvisited(32,22).
unvisited(32,24).
unvisited(32,26).
unvisited(32,28).
unvisited(32,30).
unvisited(32,32).
unvisited(32,34).
unvisited(34,0).
unvisited(34,2).
unvisited(34,4).
unvisited(34,6).
unvisited(34,8).
unvisited(34,10).
unvisited(34,12).
unvisited(34,14).
unvisited(34,16).
unvisited(34,18).
unvisited(34,20).
unvisited(34,22).
unvisited(34,24).
unvisited(34,26).
unvisited(34,28).
unvisited(34,30).
unvisited(34,32).
unvisited(34,34).

border(X,-1).
border(-1,Y).
border(X,Y) :- grid_size(X,_).
border(X,Y) :- grid_size(_,Y).

abs(X, X) :- X > -1.
abs(X, AbsX) :- AbsX = -X.

possible(right) :- pos(MyX, MyY) & not (obstacle(MyX+1, MyY) | border(MyX+1, MyY)).
possible(up) :- pos(MyX, MyY) & not (obstacle(MyX, MyY-1) | border(MyX, MyY-1)).
possible(left) :- pos(MyX, MyY) & not (obstacle(MyX-1, MyY) | border(MyX-1, MyY)).
possible(down) :- pos(MyX, MyY) & not (obstacle(MyX, MyY+1) | border(MyX, MyY+1)).

complement_x_dir(left, right).
complement_x_dir(right, left).
complement_x_dir(none, left).
complement_y_dir(up, down).
complement_y_dir(down, up).
complement_y_dir(none, down).

is_x_dir(left).
is_x_dir(right).
is_y_dir(up).
is_y_dir(down).

get_x_dir(MyX, TargetX, right) :- TargetX > MyX.
get_x_dir(MyX, TargetX, left) :- TargetX < MyX.
get_x_dir(MyX, TargetX, none) :- TargetX == MyX.
get_y_dir(MyY, TargetY, up) :- TargetY < MyY.
get_y_dir(MyY, TargetY, down) :- TargetY > MyY.
get_y_dir(MyY, TargetY, none) :- TargetY == MyY.

//primitiva
first([H|T], H).
second([H|T], HH) :- first(T, HH).
// pridani prvku na zacatek seznamu
prepend(H,[], [H]).
prepend(H,L, [H|L]).
// test, zda X lezi v intervalu (From,To)
between(X, From, To) :- From < To & X > From & X < To.
between(X, From, To) :- From > To & X < From & X > To.
// vzdalenost mezi dvema body v 1D
euler_dist(A,B,Dist) :- A > B & Dist = A - B.
euler_dist(A,B,Dist) :- A < B & Dist = B - A.
euler_dist(A,B,0) :- A=B.

// GOTO PLAN - nejdrive jede k depotu, pak krouzi kolem nej
goto_plan([[X,Y]]) :- depot(X,Y). // nejdrive jed k depotu
empty_goto_plan :- goto_plan([]).
get_first_position(X,Y) :- goto_plan([H|T]) & first(H, X) & second(H, Y).

// Zjistovani, jestli mezi dvema body na jedne souradnici lezi prekazka
obstacle_on_x_path(X1,X2,Y) :- known_obstacle(Xobs, Y) & between(Xobs, X1, X2).
obstacle_on_y_path(Y1,Y2,X) :-known_obstacle(X, Yobs) & between(Yobs, Y1, Y2).

// zjistovani vzdalenosti mezi dvema body na stejne souradnici
distance_x_line(X1, X2, Y, Dist) :- obstacle_on_x_path(X1,X2,Y) & 
                                    euler_dist(X1,X2,D) & 
								    Dist = D + 3.
distance_x_line(X1, X2, Y, Dist) :- euler_dist(X1,X2,Dist).
distance_y_line(Y1, Y2, X, Dist) :- obstacle_on_y_path(Y1,Y2,X) & 
                                    euler_dist(Y1,Y2,D) & 
									Dist = D + 3.
distance_y_line(Y1, Y2, X, Dist) :- euler_dist(Y1,Y2,Dist).



// zjistovani vzdalenosti mezi dvema libovolnymi body
//distance(X1,Y1,X2,Y2,0).

distance(MyX,MyY,X,Y,Dist) :- pos(MyX,MyY) &
                              distance_x_line(MyX, X, Y, Dist_Y) &
							  distance_x_line(MyX, X, MyY, Dist_MyY) &
							  distance_y_line(MyY, Y, X, Dist_X) &
							  distance_y_line(MyY, Y, MyX, Dist_MyX) &
							  A = Dist_MyX + Dist_Y &
							  B = Dist_MyY + Dist_X &
							  .min([A,B],Dist).

// predikat pro zjisteni, jestli bod (X,Y) lezi na hraci plose
on_board(X,Y) :- grid_size(GX,GY) & between(X,-1,GX+1) & between(Y, -1, GY+1).


// zjisteni vsech bodu, ktere jsou aktualne od agenta nejblize
min_distance(Unvisited,UnvisitedMinDistList) :-
    min_distance_worker(Unvisited,1000,[],UnvisitedMinDistList).

min_distance_worker([],_,K,K).

min_distance_worker([H|T],MinDist,Keeper,UnvisitedMinDistList) :-
    //.print(Keeper) &
    pos(PosX,PosY) & first(H,Xtarget) & second(H,Ytarget) &
    distance(PosX,PosY,Xtarget,Ytarget,Dist) &
	Dist < MinDist &
	min_distance_worker(T,Dist,[H],UnvisitedMinDistList).

min_distance_worker([H|T],MinDist,Keeper,UnvisitedMinDistList) :-
    //.print(Keeper) &
    pos(PosX,PosY) & first(H,Xtarget) & second(H,Ytarget) &
    distance(PosX,PosY,Xtarget,Ytarget,Dist) &
	Dist = MinDist & .concat([H],Keeper,NewKeeper) & 
	min_distance_worker(T,Dist,NewKeeper,UnvisitedMinDistList).

min_distance_worker([H|T],MinDist,Keeper,UnvisitedMinDistList) :-
    //.print(Keeper) &
    pos(PosX,PosY) & first(H,Xtarget) & second(H,Ytarget) &
    distance(PosX,PosY,Xtarget,Ytarget,Dist) &
	Dist > MinDist &
	min_distance_worker(T,MinDist,Keeper,UnvisitedMinDistList).


// pomocny rekurzivni srotovac pro naplanovani vsech bodu z listu UnvisitedMinDistList
+!plan_nearest_unvisited_worker([]) <- true.	   
+!plan_nearest_unvisited_worker([H|T])
    <- ?first(H,X); ?second(H,Y);
	   !plan_best_path(X,Y);
	   !plan_nearest_unvisited_worker(T).
	   
// prida do planu nejblizsi nenavstivene body na mape
+!plan_nearest_unvisited
    <- .findall([X,Y], unvisited(X,Y), Unvisited);
	   ?min_distance(Unvisited,UnvisitedMinDistList);
	   !plan_nearest_unvisited_worker(UnvisitedMinDistList).
	   
// prida bod na zacatek planu
+!prepend_to_goto_plan(X,Y)
    <- ?goto_plan(G);
	   ?prepend([X,Y],G,GG);
	   -goto_plan(_);
	   +goto_plan(GG).
	
// naplanuje do goto planu nejlepsi moznou cestu do bodu A[X,Y]
+!plan_best_path(X,Y) : pos(MyX, MyY)
    <- ?distance_x_line(MyX, X, Y, Dist_Y);
	   ?distance_x_line(MyX, X, MyY, Dist_MyY);
	   ?distance_y_line(MyY, Y, X, Dist_X);
	   ?distance_y_line(MyY, Y, MyX, Dist_MyX);
	   // naplanuju cestu do cile
	   !prepend_to_goto_plan(X,Y);
	   // pokud je cesta po y a pak po x mensi
	   if ((Dist_MyX + Dist_Y) < (Dist_MyY + Dist_X)) {
		   // jdeme z (MyX,MyY) do (MyX,Y)
	       !prepend_to_goto_plan(MyX,Y);
	   }
	   else { // jinak je cesta po x a pak po y mensi
		   // jdeme z (MyX,MyY) do (X,MyY)
	       !prepend_to_goto_plan(X,MyY);
	   }.

// pridani vsech viditelnych prekazek do databaze znalosti agenta
//+!add_obstacles : obstacle(X,Y)
//    <- +known_obstacle(X,Y); -unvisited(X,Y).
+!add_obstacles
    <- .findall([X,Y], obstacle(X,Y), VisibleObstacles);
	    !add_obstacles_worker(VisibleObstacles).

+!add_obstacles_worker([]) <- true.
+!add_obstacles_worker([H|T])
    <- ?first(H,X); ?second(H,Y); // ziskani souradnic
	   .print("Mam prekazku na [", X, ",", Y, "]");
	   +known_obstacle(X,Y); -unvisited(X,Y); // zapsani prekazky do db
	   !add_obstacles_worker(T).

// odstrani prvni prvek z goto planu
+!pop_first_position
    <- ?goto_plan([H|T]);
	   -goto_plan(_);
	   +goto_plan(T).

+!change_complement_x_dir
    <- ?complement_x_dir(none, X);
	   ?complement_x_dir(X, CompX);
	   -complement_x_dir(none, _);
	   +complement_x_dir(none, CompX).

+!change_complement_y_dir
    <- ?complement_y_dir(none, Y);
	   ?complement_y_dir(Y, CompY);
	   -complement_y_dir(none, _);
	   +complement_y_dir(none, CompY).

	   
// zruseni faktu, ze obchazim prekazku
+!reset_solving_obstacle <- -solving_obstacle(_,_).

// pokud uz tam jsi, nikam nechod
+!goto(X,Y) : pos(X,Y) <- true.

// obchazim prekazku
+!goto(X,Y) : solving_obstacle(TargetDir, SolvingDir)
    <- if (possible(TargetDir)) {
	       !reset_solving_obstacle;
	       do(TargetDir)
	   }
	   else {
	       if (possible(SolvingDir)) {
		       do(SolvingDir)
		   }
	       else {
			   if (is_x_dir(TargetDir)) {
			       ?complement_x_dir(TargetDir, CompTargetDir);
			   }
			   else {
			       ?complement_y_dir(TargetDir, CompTargetDir);
			   }
               if (possible(CompTargetDir)) {
				   !reset_solving_obstacle;
				   +solving_obstacle(SolvingDir, CompTargetDir);
				   do(CompTargetDir)
			   }
			   else {
				   if (is_x_dir(SolvingDir)) {
					   ?complement_x_dir(SolvingDir, CompSolvingDir);
				   }
				   else {
					   ?complement_y_dir(SolvingDir, CompSolvingDir);
				   }
				   if (possible(CompSolvingDir)) {
					   !reset_solving_obstacle;
					   +solving_obstacle(CompTargetDir, CompSolvingDir);
					   do(CompSolvingDir)
				   }
			   }
		   }
	   }.

// jdu normalne za cilem po x-ove ose
+!goto(X,Y) : pos(MyX, MyY) & get_x_dir(MyX, X, Xdir) & not (Xdir == none)
    <- if (possible(Xdir)) {
	       do(Xdir)
	   }
	   else {
	       ?get_y_dir(MyY, Y, Ydir);
	       if (possible(Ydir)) {
		       +solving_obstacle(Xdir,Ydir);
		       do(Ydir)
		   }
		   else {
		       ?complement_y_dir(Ydir, CompYdir);
			   !change_complement_y_dir;
			   if (possible(CompYdir)) {
			       +solving_obstacle(Xdir, CompYdir);
				   do(CompYdir)
			   }
			   else {
			       ?complement_x_dir(Xdir, CompXdir);
				   !change_complement_x_dir;
				   +solving_obstacle(Xdir, CompXdir);
				   do(CompXdir)
			   }
		   }
	   }.

+!goto(X,Y) : pos(MyX, MyY) & get_y_dir(MyY, Y, Ydir) & not (Ydir == none)
    <- if (possible(Ydir)) {
	       do(Ydir)
	   }
	   else {
	       ?get_x_dir(MyX, X, Xdir);
	       if (possible(Xdir)) {
		       +solving_obstacle(Ydir, Xdir);
		       do(Xdir)
		   }
		   else {
		       ?complement_x_dir(Xdir, CompXdir);
			   !change_complement_x_dir;
			   if (possible(CompXdir)) {
			       +solving_obstacle(Ydir, CompXdir);
				   do(CompXdir)
			   }
			   else {
			       ?complement_y_dir(Ydir, CompYdir);
				   !change_complement_y_dir;
				   +solving_obstacle(Ydir, CompYdir);
				   do(CompYdir)
			   }
		   }
	   }.

// udela jeden krok k prvni naplanovane pozici
// pokud nejsou zadne naplanovane pozice, jde tam, kde jeste nebyl
+!goto_next_position : pos(MyX,MyY)
    <- // zaznamenam, si, kde jsem
	   -unvisited(MyX,MyY);
	   // pridej vsechny prekazky o kterych vis toto kolo
	   !add_obstacles;
	   // pokud nemas prazdny plan, tak jedem
	   if(not empty_goto_plan) {
	       // ziskani prvni pozice z planu, kam se ma jet
	       ?get_first_position(X,Y);
		   
		   // Pokud je tam prekazka (tzn pozice byla naplanovana pred tim, nez
		   // jsem uvidel, ze tam je prekazka), tak tam nejedu a pokracuju dal.
		   // Pokud uz na naplanovane pozici stojim, tak samozrejme jedu na dalsi
		   if (pos(X,Y) | known_obstacle(X,Y)) {
		       // odstraneni prvniho prvku v goto planu
		       !pop_first_position;
			   // rekurzivne se zavola sam na sebe (jede na dalsi prvek v goto planu)
			   !goto_next_position
		   }
		   else {
		       !goto(X,Y)
		   }
	   }
	   else {
	       !plan_nearest_unvisited;
		   !goto_next_position
	   }.

// dela kroky dokud v danem kole muze
+!do_step : moves_left(M) & (M > 1) 
      <- !goto_next_position;
		 !do_step.

+!do_step : moves_left(M) & M == 1
      <- !goto_next_position.

+step(X)
    <- !do_step.


